# CI workflow for linting, type checking, testing, and building the project.
name: CI

# Assign a run name to the workflow.
run-name: "${{ github.workflow }} #${{ github.run_number }} triggered by @${{ github.actor }}"

# Filter for determining when to trigger the workflow.
on:
  # Runs on pushes to the `main` branch only.
  push:
    branches:
      - main

  # Runs on pull requests targeting the `main` branch only. Pull request `opened`, `synchronize` and
  # `reopened` events trigger the workflow.
  pull_request:
    branches:
      - main

  # Permit triggering the workflow manually.
  workflow_dispatch:

jobs:
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '24'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint

  type-check:
    name: TypeScript Type Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '24'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Run Type Check
        run: npm run type-check

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '24'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Run Tests With Coverage
        run: npm test -- --run --coverage

      - name: Generate Coverage Summary
        if: always()
        run: |
          if [ -f "coverage/coverage-summary.json" ]; then
            echo "## Test Coverage Summary" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            node -e "
            const coverage = require('./coverage/coverage-summary.json');
            const total = coverage.total;
            const metrics = ['lines', 'statements', 'functions', 'branches'];
            console.log('| Metric | Coverage |');
            console.log('|--------|----------|');
            metrics.forEach(metric => {
              const pct = total[metric].pct;
              const emoji = pct >= 80 ? '‚úÖ' : pct >= 60 ? '‚ö†Ô∏è' : '‚ùå';
              console.log(\`| \${emoji} \${metric.charAt(0).toUpperCase() + metric.slice(1)} | \${pct}% |\`);
            });
            " >> $GITHUB_STEP_SUMMARY
          fi

  build:
    name: Build Plugin
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Build Plugin
        run: npm run build

      - name: Verify Build Artifacts
        run: |
          if [ ! -f "dist/plugin.js" ]; then
            echo "‚ùå dist/plugin.js not found"
            exit 1
          fi
          if [ ! -f "dist/index.html" ]; then
            echo "‚ùå dist/index.html not found"
            exit 1
          fi
          if [ ! -f "dist/manifest.json" ]; then
            echo "‚ùå dist/manifest.json not found"
            exit 1
          fi
          echo "‚úÖ Build artifacts verified"

      - name: Check Bundle Sizes
        run: |
          PLUGIN_SIZE=$(stat -f%z "dist/plugin.js" 2>/dev/null || stat -c%s "dist/plugin.js")
          UI_SIZE=$(stat -f%z "dist/index.html" 2>/dev/null || stat -c%s "dist/index.html")
          echo "üì¶ Plugin bundle: $(numfmt --to=iec-i --suffix=B $PLUGIN_SIZE)"
          echo "üì¶ UI bundle: $(numfmt --to=iec-i --suffix=B $UI_SIZE)"
          
          # Warn if bundles are too large (plugin >100KB, UI >500KB)
          if [ $PLUGIN_SIZE -gt 102400 ]; then
            echo "‚ö†Ô∏è  Warning: Plugin bundle is larger than 100KB"
          fi
          if [ $UI_SIZE -gt 512000 ]; then
            echo "‚ö†Ô∏è  Warning: UI bundle is larger than 500KB"
          fi

      - name: Package Development Plugin
        run: npm run package:zip

      - name: Get Plugin Version
        id: package-version
        run: echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v5
        with:
          name: plugin-build
          path: dist/
          retention-days: 30

      - name: Upload Development Plugin Package
        uses: actions/upload-artifact@v5
        with:
          name: figgit-${{ steps.package-version.outputs.version }}
          path: figgit-${{ steps.package-version.outputs.version }}.zip
          retention-days: 30

  all-checks:
    name: All Checks Passed
    runs-on: ubuntu-latest
    needs: [ lint, type-check, test, build ]
    if: always()
    
    steps:
      - name: Run All Checks
        run: |
          if [ "${{ needs.lint.result }}" != "success" ] || \
             [ "${{ needs.type-check.result }}" != "success" ] || \
             [ "${{ needs.test.result }}" != "success" ] || \
             [ "${{ needs.build.result }}" != "success" ]; then
            echo "‚ùå One or more checks failed"
            exit 1
          fi
          echo "‚úÖ All checks passed!"
